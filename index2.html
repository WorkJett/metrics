<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Series</title>
  <style>
    html {
      min-width: 1040px;
    }

    body {
      font-family: "Helvetica Neue", Helvetica, sans-serif;
      margin: auto;
      margin-top: 40px;
      margin-bottom: 4em;
      width: 960px;
    }

    #body {
      position: relative;
    }

    footer {
      font-size: small;
      margin-top: 8em;
    }

    aside {
      font-size: small;
      left: 780px;
      position: absolute;
      width: 180px;
    }

    #body > p, li > p {
      line-height: 1.5em;
    }

    #body > p {
      width: 720px;
    }

    #body > blockquote {
      width: 640px;
    }

    li {
      width: 680px;
    }

    a {
      color: steelblue;
    }

    a:not(:hover) {
      text-decoration: none;
    }

    pre, code, textarea {
      font-family: "Menlo", monospace;
    }

    code {
      line-height: 1em;
    }

    textarea {
      font-size: 100%;
    }

    #body > pre {
      border-left: solid 2px #ccc;
      padding-left: 18px;
      margin: 2em 0 2em -20px;
    }

    .html .value,
    .javascript .string,
    .javascript .regexp {
      color: #756bb1;
    }

    .html .tag,
    .css .tag,
    .javascript .keyword {
      color: #3182bd;
    }

    .comment {
      color: #636363;
    }

    .html .doctype,
    .javascript .number {
      color: #31a354;
    }

    .html .attribute,
    .css .attribute,
    .javascript .class,
    .javascript .special {
      color: #e6550d;
    }

    svg {
      font: 10px sans-serif;
    }

    .axis path, .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    sup, sub {
      line-height: 0;
    }

    q:before,
    blockquote:before {
      content: "“";
    }

    q:after,
    blockquote:after {
      content: "”";
    }

    blockquote:before {
      position: absolute;
      left: 2em;
    }

    blockquote:after {
      position: absolute;
    }

    h1 {
      font-size: 96px;
      margin-top: .3em;
      margin-bottom: 0;
    }

    h1 + h2 {
      margin-top: 0;
    }

    h2 {
      font-weight: 400;
      font-size: 28px;
    }

    h1, h2 {
      font-family: "Yanone Kaffeesatz";
      text-rendering: optimizeLegibility;
    }

    #logo {
      width: 122px;
      height: 31px;
    }

    #fork {
      position: absolute;
      top: 0;
      right: 0;
    }

    .axis {
      font: 10px sans-serif;
    }

    .axis text {
      -webkit-transition: fill-opacity 250ms linear;
    }

    .axis path {
      display: none;
    }

    .axis line {
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .horizon {
      border-bottom: solid 1px #000;
      overflow: hidden;
      position: relative;
    }

    .horizon {
      border-top: solid 1px #000;
      border-bottom: solid 1px #000;
    }

    .horizon + .horizon {
      border-top: none;
    }

    .horizon canvas {
      display: block;
    }

    .horizon .title,
    .horizon .value {
      bottom: 0;
      margin: 0 6px;
      position: absolute;
      text-shadow: 0 1px 0 rgba(255,255,255,.5);
      white-space: nowrap;
    }

    .horizon .title {
      left: 0;
    }

    .horizon .value {
      right: 0;
    }

    .line {
      background: #000;
      opacity: .2;
      z-index: 2;
    }
    #example1 {
      position: relative;
    }
  </style>
  <script src="https://d3js.org/d3.v2.min.js" charset="utf-8"></script>
  <script src="https://square.github.io/cubism/cubism.v1.min.js"></script>
</head>
<body>
  <div id="example1" />
  <script type="application/javascript">
    const param = new URLSearchParams(window.location.search).get('param')
    let flows = []
    const check = val => {
      if(flows.indexOf(val) < 0) flows.push(val)
    }
    if(param) {
      const params = param.split(',')
      for(let val of params) {
        if(val.indexOf('-') >= 0) {
          const vals = val.split('-')
          for(let each_val of vals) check(each_val)
        } else if(val.indexOf(' ') >=0) {
          const vals = val.split(' ')
          for(let each_val of vals) check(each_val)
        } else check(val)
      }
    }

    let source = name => {
      return context.metric(function (start, stop, step, callback) {
        const values = []
        values.push(Math.random() * 20 - 10)
        values.push(Math.random() * 20 - 10)
        values.push(Math.random() * 20 - 10)
        values.push(Math.random() * 20 - 10)
        values.push(Math.random() * 20 - 10)
        values.push(Math.random() * 20 - 10)
        values.push(Math.random() * 20 - 10)
        values.push(Math.random() * 20 - 10)
        values.push(Math.random() * 20 - 10)
        values.push(Math.random() * 20 - 10)
        callback(null, values)
        //fetch(`http://localhost:8080/metrics?ids=${name}`, {mode: 'cors'})
        //  .then(res => res.json()).then(res => {
        //    let val = +res[name]
        //    let values = [val, val, val, val]
        //    callback(null, values)
        //  })
      }, name)
    }

    var context = cubism.context()
        .serverDelay(0)
        .clientDelay(0)
        .step(1000)
        .size(960);

    const sources = {}

    for(let each_flow of flows) sources[each_flow] = source(each_flow)

    const data = []

    if(param) {
      const params = param.split(',')
      for(let val of params) {
        if(val.indexOf('-') >= 0) {
          const vals = val.split('-')
          const source_one = sources[vals[0]]
          const source_two = sources[vals[1]]
          data.push(source_one.subtract(source_two))
        } else if(val.indexOf(' ') >=0) {
          const vals = val.split(' ')
          const source_one = sources[vals[0]]
          const source_two = sources[vals[1]]
          data.push(source_one.add(source_two))
        } else data.push(sources[val])
      }
    }

    let
      earth = source('Earth'),
      mars = source('Mars'),
      neptune = source('Neptune'),
      jupiter = source('Jupiter')
      

    d3.select("#example1").call(function(div) {

      div.append("div")
          .attr("class", "axis")
          .call(context.axis().orient("top"));

      div.selectAll(".horizon")
          .data(data)
        .enter().append("div")
          .attr("class", "horizon")
          .call(context.horizon().height(120).extent([-20, 20]));

      div.append("div")
          .attr("class", "rule")
          .call(context.rule());

    });

    // On mousemove, reposition the chart values to match the rule.
    context.on("focus", function(i) {
      d3.selectAll(".value").style("right", i == null ? null : context.size() - i + "px");
    });
  </script>
</body>
</html>
